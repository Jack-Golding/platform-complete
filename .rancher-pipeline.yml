stages:
- name: Build and Push
  steps:
  - publishImageConfig:
      dockerfilePath: ./docker/Dockerfile
      buildContext: ./
      tag: docker.dev.folio.org/platform-complete:core-platform-${CICD_EXECUTION_SEQUENCE}
      pushRemote: true
      registry: docker.dev.folio.org
    env:
      PLUGIN_BUILD_ARGS_FROM_ENV: OKAPI_URL, TENANT_ID
    envFrom:
    - sourceName: tenant-config
      sourceKey: TENANT_ID
    - sourceName: tenant-config
      sourceKey: OKAPI_URL
    cpuRequest: 300m
    cpuLimit: 1500m
    memoryRequest: 10Gi
    memoryLimit: 10Gi
- name: Deploy
  steps:
  - applyAppConfig:
      catalogTemplate: p-jrhqp:core-platform-helmcharts-platform-complete
      version: 0.1.14
      answers:
        image.repository: docker.dev.folio.org/platform-complete
        image.tag: core-platform-${CICD_EXECUTION_SEQUENCE}
        ingress.enabled: "true"
        ingress.annotations.external-dns\.alpha\.kubernetes\.io/target: f2b6996c-kubesystem-albing-accc-1096161577.us-west-2.elb.amazonaws.com
        ingress.hosts[0].host: core-platform.ci.folio.org
        ingress.hosts[0].paths[0]: /
        postJob.enabled: "true"
        resources.limits.cpu: 700m
        resources.limits.memory: 786Mi
      name: platform-complete
      targetNamespace: core-platform
timeout: 60
branch:
  include:
  - core-platform-rancher
notification: {}
